---
- import_playbook: copy-env.yml

- name: 06 - Deploy n8n Automation Server Stack
  hosts: all_guardians
  become: yes

  vars:
    project_name: "n8n-service"
    docker_compose_file_name: "docker-compose-n8n.yml"

    source_docker_compose_file: "{{ main_repo_source_dir }}/docker/{{ docker_compose_file_name }}"
    remote_docker_compose_file: "{{ remote_deploy_base }}/{{ docker_compose_file_name }}"

    host_uid: "{{ lookup('ansible.builtin.pipe', 'id -u ' + deployment_user) }}"
    host_gid: "{{ lookup('ansible.builtin.pipe', 'id -g ' + deployment_user) }}"
    n8n_host_ip: "{{ ansible_host }}"

  tasks:
    - name: Task 1.0 - Create base deployment directory on the remote node (e.g., /home/hunter)
      ansible.builtin.file:
        path: "{{ remote_deploy_base }}"
        state: directory
        owner: "{{ deployment_user }}"
        group: "{{ deployment_user }}"
        mode: '0755'

    # --- Copying Core Files ---
    - name: Task 1.1 - Copy the n8n Docker Compose file (docker-compose-n8n.yml)
      ansible.builtin.copy:
        src: "{{ source_docker_compose_file }}"
        dest: "{{ remote_docker_compose_file }}"
        owner: "{{ deployment_user }}"
        group: "{{ deployment_user }}"
        mode: '0644'

    - name: Task 2.0 - Deploy n8n service using shell/docker-compose with sudo
      ansible.builtin.shell:
        cmd: |
          UID={{ host_uid }} GID={{ host_gid }} N8N_HOST={{ n8n_host_ip }} \
          sudo docker compose -f {{ docker_compose_file_name }} -p {{ project_name }} up --build -d
        chdir: "{{ remote_deploy_base }}"
      register: deploy_output

    - name: Task 2.1 - Display deployment status and access info
      ansible.builtin.debug:
        msg: |
          Deployment of n8n Automation Server on {{ inventory_hostname }} finished.
          Web UI is accessible at: http://{{ ansible_host }}:5678
          Output: {{ deploy_output.stdout }}